<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css">
  <title>Crypto Tracker Dashboard</title>
</head>
<body>

<header>
  <h1>ðŸ’¹ Crypto Currency Tracker</h1>
</header>

<div id="loader" class="loader"></div>

<table id="crypto-table" style="display:none;">
  <thead>
    <tr>
      <th>Rank</th>
      <th>Coin</th>
      <th>Symbol</th>
      <th>Price (USD)</th>
      <th>24h Change</th>
      <th>Market Cap</th>
    </tr>
  </thead>
  <tbody id="crypto-body"></tbody>
</table>

<footer>
  Powered by <a href="https://www.coingecko.com/" target="_blank" style="color:#00ff99;">CoinGecko API</a>
</footer>

<!-- ===================== -->
<!-- REQUIRED LIBRARIES -->
<!-- ===================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

<script>
const apiUrl =
  "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false";

const charts = {};

/* =========================
   LIVE GRAPH FUNCTION
   ========================= */
async function loadChart(coinId, canvasId) {
  const url = `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=1`;
  const res = await fetch(url);
  const data = await res.json();

  const prices = data.prices.map(p => ({
    x: new Date(p[0]),
    y: p[1]
  }));

  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  const ctx = canvas.getContext("2d");

  if (charts[coinId]) {
    charts[coinId].data.datasets[0].data = prices;
    charts[coinId].update();
    return;
  }

  charts[coinId] = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [{
        data: prices,
        borderColor: "#00ff99",
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        zoom: {
          pan: { enabled: true, mode: "x" },
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: "x"
          }
        }
      },
      scales: {
        x: { type: "time" }
      }
    }
  });
}

/* =========================
   TABLE DATA
   ========================= */
async function fetchCryptoData() {
  try {
    const response = await fetch(apiUrl);
    const data = await response.json();

    const tbody = document.getElementById("crypto-body");
    const loader = document.getElementById("loader");
    const table = document.getElementById("crypto-table");

    loader.style.display = "none";
    table.style.display = "table";
    tbody.innerHTML = "";

    data.forEach((coin, index) => {

      const row = document.createElement("tr");
      row.classList.add("coin-row");

      const changeClass =
        coin.price_change_percentage_24h >= 0 ? "price-up" : "price-down";

      row.innerHTML = `
        <td>${index + 1}</td>
        <td><img src="${coin.image}" width="22"> ${coin.name}</td>
        <td>${coin.symbol.toUpperCase()}</td>
        <td>$${coin.current_price.toLocaleString()}</td>
        <td class="${changeClass}">
          ${coin.price_change_percentage_24h.toFixed(2)}%
        </td>
        <td>$${coin.market_cap.toLocaleString()}</td>
      `;

      const detailRow = document.createElement("tr");
      detailRow.classList.add("detail-row");

      detailRow.innerHTML = `
        <td colspan="6">
          <div class="detail-content">
            <div class="detail-inner">
              <div class="detail-left">
                <h3>${coin.name}</h3>
                <p><b>Price:</b> $${coin.current_price}</p>
                <p><b>Market Cap:</b> $${coin.market_cap.toLocaleString()}</p>
                <p><b>24h Volume:</b> $${coin.total_volume.toLocaleString()}</p>
                <p><b>Supply:</b> ${coin.circulating_supply?.toLocaleString()}</p>
              </div>
              <div class="detail-right">
                <canvas id="chart-${coin.id}"></canvas>
              </div>
            </div>
          </div>
        </td>
      `;

      row.addEventListener("click", () => {
        const content = detailRow.querySelector(".detail-content");

        document.querySelectorAll(".detail-content.open").forEach(el => {
          if (el !== content) el.classList.remove("open");
        });

        content.classList.toggle("open");

        if (content.classList.contains("open")) {
          loadChart(coin.id, `chart-${coin.id}`);
        }
      });

      tbody.appendChild(row);
      tbody.appendChild(detailRow);
    });

  } catch (err) {
    console.error(err);
  }
}

fetchCryptoData();
setInterval(fetchCryptoData, 60000);
</script>

</body>
</html>